<!--pages/schedule/schedule.wxml - æ—¥ç¨‹ç®¡ç†é¡µé¢-->
<view class="container">
  <!-- é¡¶éƒ¨æ ‡ç­¾é¡µ -->
  <view class="tabs">
    <view class="tab {{activeTab === 'list' ? 'active' : ''}}" bindtap="switchTab" data-tab="list">
      <text>æ—¥ç¨‹åˆ—è¡¨</text>
    </view>
    <view class="tab {{activeTab === 'calendar' ? 'active' : ''}}" bindtap="switchTab" data-tab="calendar">
      <text>æ—¥å†è§†å›¾</text>
    </view>
  </view>

  <!-- æ—¥ç¨‹åˆ—è¡¨è§†å›¾ -->
  <view class="list-view" wx:if="{{activeTab === 'list'}}">
    <!-- ä»Šæ—¥æ—¥ç¨‹ -->
    <view class="schedule-section">
      <view class="section-header">
        <text class="section-title">ä»Šæ—¥æ—¥ç¨‹</text>
        <view class="add-btn" bindtap="showAddModal">
          <text>+ æ·»åŠ æé†’</text>
        </view>
      </view>

      <view class="schedule-list" wx:if="{{todaySchedules.length > 0}}">
        <view class="schedule-item" wx:for="{{todaySchedules}}" wx:key="id">
          <view class="schedule-time-bar">
            <text class="time-text">{{item.startTime}}</text>
            <view class="time-line"></view>
          </view>
          <view class="schedule-content-card">
            <view class="schedule-main">
              <text class="schedule-title">{{item.content}}</text>
              <text class="schedule-period">{{getPeriod(item.startTime)}}</text>
            </view>
            <view class="schedule-actions">
              <view class="action-btn edit" catchtap="editSchedule" data-item="{{item}}">
                <text>âœï¸</text>
              </view>
              <view class="action-btn delete" catchtap="deleteSchedule" data-id="{{item.id}}">
                <text>ğŸ—‘ï¸</text>
              </view>
            </view>
            <view class="tag tag-{{item.category}}">{{categoryNames[item.category]}}</view>
          </view>
        </view>
      </view>

      <view class="empty-section" wx:else>
        <text class="empty-text">ä»Šæ—¥æš‚æ— æ—¥ç¨‹å®‰æ’</text>
      </view>
    </view>

    <!-- æœªæ¥æ—¥ç¨‹ -->
    <view class="schedule-section" wx:if="{{futureSchedules.length > 0}}">
      <view class="section-header">
        <text class="section-title">æœªæ¥æ—¥ç¨‹</text>
      </view>

      <view class="schedule-list">
        <view class="schedule-item future" wx:for="{{futureSchedules}}" wx:key="id">
          <view class="schedule-date-badge">
            <text class="date-day">{{item.date.substring(8, 10)}}</text>
            <text class="date-month">{{item.date.substring(5, 7)}}æœˆ</text>
          </view>
          <view class="schedule-content-card">
            <view class="schedule-main">
              <text class="schedule-title">{{item.content}}</text>
              <text class="schedule-time-range">{{item.startTime}} - {{item.endTime}}</text>
            </view>
            <view class="schedule-actions">
              <view class="action-btn delete" catchtap="deleteSchedule" data-id="{{item.id}}">
                <text>ğŸ—‘ï¸</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ—¥å†è§†å›¾ -->
  <view class="calendar-view" wx:if="{{activeTab === 'calendar'}}">
    <view class="calendar-card card">
      <view class="calendar-header">
        <view class="month-nav" bindtap="prevMonth">â€¹</view>
        <text class="current-month">{{calendarYear}}å¹´{{calendarMonth}}æœˆ</text>
        <view class="month-nav" bindtap="nextMonth">â€º</view>
      </view>

      <view class="weekday-row">
        <text class="weekday" wx:for="{{weekDays}}" wx:key="*this">{{item}}</text>
      </view>

      <view class="days-grid">
        <view class="day-cell {{item.isToday ? 'today' : ''}} {{item.isSelected ? 'selected' : ''}} {{item.hasSchedule ? 'has-schedule' : ''}} {{item.isCurrentMonth ? '' : 'other-month'}}"
              wx:for="{{calendarDays}}"
              wx:key="date"
              bindtap="selectDate"
              data-date="{{item.date}}">
          <text class="day-num">{{item.day}}</text>
          <view class="schedule-dot" wx:if="{{item.hasSchedule}}"></view>
        </view>
      </view>
    </view>

    <!-- é€‰ä¸­æ—¥æœŸçš„æ—¥ç¨‹ -->
    <view class="selected-date-schedules card" wx:if="{{selectedDate}}">
      <view class="card-header">
        <text class="card-title">{{selectedDate}} çš„æ—¥ç¨‹</text>
        <view class="add-btn-small" bindtap="showAddModal">+ æ·»åŠ </view>
      </view>

      <view class="day-schedule-list" wx:if="{{selectedDateSchedules.length > 0}}">
        <view class="day-schedule-item" wx:for="{{selectedDateSchedules}}" wx:key="id">
          <text class="item-time">{{item.startTime}}</text>
          <text class="item-content">{{item.content}}</text>
          <view class="item-delete" catchtap="deleteSchedule" data-id="{{item.id}}">Ã—</view>
        </view>
      </view>
      <view class="empty-day" wx:else>
        <text>æš‚æ— æ—¥ç¨‹</text>
      </view>
    </view>
  </view>
</view>

<!-- æ·»åŠ /ç¼–è¾‘æ—¥ç¨‹å¼¹çª— -->
<view class="modal-mask" wx:if="{{showModal}}" bindtap="hideModal">
  <view class="modal-content" catchtap="">
    <view class="modal-header">
      <text class="modal-title">{{editingItem ? 'ç¼–è¾‘æ—¥ç¨‹' : 'æ·»åŠ æ—¥ç¨‹'}}</text>
      <view class="modal-close" bindtap="hideModal">Ã—</view>
    </view>

    <!-- å¯æ»šåŠ¨åŒºåŸŸï¼šè¡¨å•å†…å®¹éƒ½æ”¾è¿™é‡Œ -->
    <scroll-view class="modal-body" scroll-y="true" enhanced="true" show-scrollbar="false">
      <view class="form-group">
        <text class="form-label">æ—¥æœŸ</text>
        <picker mode="date" value="{{formData.date}}" bindchange="onDateChange">
          <view class="picker-value">{{formData.date || 'è¯·é€‰æ‹©æ—¥æœŸ'}}</view>
        </picker>
      </view>

      <view class="form-row">
        <view class="form-group half">
          <text class="form-label">å¼€å§‹æ—¶é—´</text>
          <picker mode="time" value="{{formData.startTime}}" bindchange="onStartTimeChange">
            <view class="picker-value">{{formData.startTime || '09:00'}}</view>
          </picker>
        </view>
        <view class="form-group half">
          <text class="form-label">ç»“æŸæ—¶é—´</text>
          <picker mode="time" value="{{formData.endTime}}" bindchange="onEndTimeChange">
            <view class="picker-value">{{formData.endTime || '10:00'}}</view>
          </picker>
        </view>
      </view>

      <view class="form-group">
        <text class="form-label">å†…å®¹</text>
        <textarea class="form-textarea"
                  placeholder="è¯·è¾“å…¥æ—¥ç¨‹å†…å®¹"
                  placeholder-class="ph-color"
                  value="{{formData.content}}"
                  bindinput="onContentInput"
                  auto-height="true"
                  fixed="true"
                  cursor-spacing="20"
                  maxlength="100"
                  confirm-type="done"
                  show-confirm-bar="true"
                  hold-keyboard="true" />
      </view>

      <view class="form-group">
        <text class="form-label">åˆ†ç±»</text>
        <view class="category-options">
          <view class="category-option {{formData.category === 'work' ? 'selected' : ''}}"
                bindtap="selectCategory" data-category="work">
            <text>ğŸ’¼ å·¥ä½œ</text>
          </view>
          <view class="category-option {{formData.category === 'life' ? 'selected' : ''}}"
                bindtap="selectCategory" data-category="life">
            <text>ğŸ  ç”Ÿæ´»</text>
          </view>
          <view class="category-option {{formData.category === 'study' ? 'selected' : ''}}"
                bindtap="selectCategory" data-category="study">
            <text>ğŸ“š å­¦ä¹ </text>
          </view>
        </view>
      </view>

      <!-- ç»™åº•éƒ¨æŒ‰é’®é¢„ç•™ç©ºé—´ï¼Œé¿å…è¢«é®æŒ¡ -->
      <view style="height: 140rpx;"></view>
    </scroll-view>

    <!-- å›ºå®šåº•éƒ¨æŒ‰é’®æ¡ï¼šæ°¸è¿œå¯è§ -->
    <view class="modal-footer" catchtap="">
      <button class="btn btn-primary submit-btn" bindtap="submitSchedule" loading="{{submitting}}">
        {{submitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}}
      </button>
    </view>
  </view>
</view>

